#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Pre-commit validation..."

# Auto-fix code formatting BEFORE testing (zero friction)
echo "ğŸ”§ Auto-formatting code..."
dotnet format src/Darklands.Core.csproj --verbosity minimal
if [ $? -eq 0 ]; then
    # Stage any formatting changes automatically
    git add -u 2>/dev/null
    echo "âœ… Code formatted automatically"
else
    echo "âš ï¸  Could not auto-format (continuing anyway)"
fi

# Run Core tests (fast feedback)
echo "Running Core tests..."
dotnet test tests/Darklands.Core.Tests.csproj --no-build --verbosity minimal
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed. Attempting auto-fix..."

    # Try to rebuild in case of stale builds
    echo "ğŸ”§ Attempting fresh build..."
    dotnet build src/Darklands.Core.csproj --verbosity minimal

    # Retry tests
    dotnet test tests/Darklands.Core.Tests.csproj --no-build --verbosity minimal
    if [ $? -ne 0 ]; then
        echo "âŒ Tests still failing after rebuild. Please fix manually."
        echo "ğŸ’¡ Tip: Run './scripts/test/quick.ps1' for detailed output"
        exit 1
    fi
    echo "âœ… Tests passed after rebuild"
fi

echo "âœ… Pre-commit validation passed!"