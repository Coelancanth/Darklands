#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Pre-commit validation..."

# Auto-fix code formatting BEFORE testing (zero friction)
echo "🔧 Auto-formatting code..."
dotnet format src/Darklands.Core.csproj --verbosity minimal
if [ $? -eq 0 ]; then
    # Stage any formatting changes automatically
    git add -u 2>/dev/null
    echo "✅ Code formatted automatically"
else
    echo "⚠️  Could not auto-format (continuing anyway)"
fi

# Run Core tests (fast feedback)
echo "Running Core tests..."
dotnet test tests/Darklands.Core.Tests.csproj --no-build --verbosity minimal
if [ $? -ne 0 ]; then
    echo "❌ Tests failed. Attempting auto-fix..."

    # Try to rebuild in case of stale builds
    echo "🔧 Attempting fresh build..."
    dotnet build src/Darklands.Core.csproj --verbosity minimal

    # Retry tests
    dotnet test tests/Darklands.Core.Tests.csproj --no-build --verbosity minimal
    if [ $? -ne 0 ]; then
        echo "❌ Tests still failing after rebuild. Please fix manually."
        echo "💡 Tip: Run './scripts/test/quick.ps1' for detailed output"
        exit 1
    fi
    echo "✅ Tests passed after rebuild"
fi

echo "✅ Pre-commit validation passed!"