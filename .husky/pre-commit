#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Pre-commit validation (fast mode)..."

# Auto-fix code formatting BEFORE testing (zero friction)
echo "🔧 Auto-formatting code..."
dotnet format Darklands.sln --verbosity minimal
if [ $? -eq 0 ]; then
    # Stage any formatting changes automatically
    git add -u 2>/dev/null
    echo "✅ Code formatted automatically"
else
    echo "⚠️  Could not auto-format (continuing anyway)"
fi

# FAST MODE: Only run quick architecture tests (<2 seconds)
echo "⚡ Running quick architecture tests..."
dotnet test tests/Darklands.Core.Tests.csproj --no-build --verbosity minimal --filter "Category=Architecture" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "❌ Architecture tests failed."
    echo "💡 Tip: Run './scripts/test/quick.ps1' for details"
    echo "💡 To run full tests: './scripts/core/build.ps1 test'"
    exit 1
fi

echo "✅ Pre-commit validation passed (fast mode)!"
echo "💡 Full tests will run on pre-push"